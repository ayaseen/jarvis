<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS Document Manager - RAG System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        h1 {
            font-size: 3em;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #00d4ff;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .nav-buttons {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            display: inline-block;
            color: #00d4ff;
            text-decoration: none;
            padding: 10px 20px;
            border: 2px solid #00d4ff;
            border-radius: 20px;
            transition: all 0.3s;
            background: rgba(0, 212, 255, 0.1);
        }
        
        .nav-btn:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .status-good { color: #4ade80; }
        .status-warning { color: #fbbf24; }
        .status-bad { color: #f87171; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: #00d4ff;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 2px dashed #00d4ff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            background: rgba(0, 212, 255, 0.05);
        }
        
        .upload-area.dragover {
            background: rgba(0, 212, 255, 0.2);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #00d4ff;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 2px solid #00d4ff;
            color: #fff;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            margin-top: 20px;
        }
        
        .upload-btn:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: scale(1.05);
        }
        
        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00d4ff;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 5px;
            color: #fff;
            font-size: 1em;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Courier New', monospace;
        }
        
        .documents-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .document-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .document-item:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: translateX(5px);
        }
        
        .doc-name {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .doc-info {
            color: #a0a0a0;
            font-size: 0.9em;
            display: flex;
            gap: 15px;
        }
        
        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .collection-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .collection-card:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }
        
        .collection-card.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
        }
        
        .collection-name {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .collection-count {
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            position: relative;
        }
        
        .tab:hover {
            color: #00d4ff;
        }
        
        .tab.active {
            color: #00d4ff;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00d4ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.8em;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
        }
        
        .alert-success {
            background: rgba(52, 211, 153, 0.2);
            border: 1px solid #34d399;
        }
        
        .alert-error {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid #f87171;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 25px;
            color: #fff;
            font-size: 1em;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #00d4ff;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0a0a0;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                position: static;
                justify-content: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-buttons">
                <a href="/" class="nav-btn">üìä Chat</a>
                <a href="/models.html" class="nav-btn">‚öôÔ∏è Models</a>
            </div>
            <h1>üìö JARVIS Document Manager</h1>
            <div class="subtitle">RAG Knowledge Base Management System</div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">RAG Status</div>
                <div class="status-value" id="ragStatus">
                    <span class="status-warning">Checking...</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Milvus Status</div>
                <div class="status-value" id="milvusStatus">
                    <span class="status-warning">Checking...</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Total Documents</div>
                <div class="status-value" id="totalDocs">
                    <span class="status-warning">0</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Total Chunks</div>
                <div class="status-value" id="totalChunks">
                    <span class="status-warning">0</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Active Collection</div>
                <div class="status-value" id="activeCollection">
                    <span class="status-good">documents</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Left Panel - Upload & Input -->
            <div class="card">
                <h2>üì§ Add Knowledge</h2>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('upload')">üìÑ Upload File</button>
                    <button class="tab" onclick="switchTab('text')">‚úèÔ∏è Input Text</button>
                    <button class="tab" onclick="switchTab('url')">üîó From URL</button>
                </div>
                
                <!-- Upload Tab -->
                <div id="uploadTab" class="tab-content active">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <p>Drag & drop files here or click to browse</p>
                        <p style="color: #a0a0a0; font-size: 0.9em; margin-top: 10px;">
                            Supported: PDF, TXT, DOCX, MD, JSON, CSV, HTML, XML
                        </p>
                        <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.txt,.docx,.doc,.md,.json,.csv,.html,.xml,.py,.js,.log">
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Choose Files
                        </button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="collectionSelect">Target Collection:</label>
                        <select id="collectionSelect">
                            <option value="documents">üìö Documents (Default)</option>
                            <option value="conversations">üí¨ Conversations</option>
                            <option value="knowledge">üß† Knowledge Base</option>
                        </select>
                    </div>
                    
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                        </div>
                        <p style="margin-top: 10px; text-align: center;" id="uploadStatus">Uploading...</p>
                    </div>
                    
                    <div id="uploadResults"></div>
                </div>
                
                <!-- Text Input Tab -->
                <div id="textTab" class="tab-content">
                    <div class="form-group">
                        <label for="textTitle">Title:</label>
                        <input type="text" id="textTitle" placeholder="Enter document title...">
                    </div>
                    
                    <div class="form-group">
                        <label for="textContent">Content:</label>
                        <textarea id="textContent" placeholder="Paste or type your text here..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="textCollection">Collection:</label>
                        <select id="textCollection">
                            <option value="documents">üìö Documents</option>
                            <option value="conversations">üí¨ Conversations</option>
                            <option value="knowledge">üß† Knowledge Base</option>
                        </select>
                    </div>
                    
                    <button class="upload-btn" onclick="submitText()" style="width: 100%;">
                        Add to Knowledge Base
                    </button>
                </div>
                
                <!-- URL Tab -->
                <div id="urlTab" class="tab-content">
                    <div class="form-group">
                        <label for="urlInput">Website URL:</label>
                        <input type="url" id="urlInput" placeholder="https://example.com/article">
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Note:</strong> URL scraping will extract text content from the webpage.
                    </div>
                    
                    <button class="upload-btn" onclick="submitUrl()" style="width: 100%;">
                        Fetch & Index Content
                    </button>
                </div>
                
                <!-- Collections Overview -->
                <h2 style="margin-top: 30px;">üìÇ Collections</h2>
                <div class="collections-grid" id="collectionsGrid">
                    <!-- Collections will be loaded here -->
                </div>
            </div>
            
            <!-- Right Panel - Documents List -->
            <div class="card">
                <h2>üìñ Knowledge Base</h2>
                
                <!-- Search -->
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search documents...">
                    <span class="search-icon">üîç</span>
                </div>
                
                <!-- Documents List -->
                <div class="documents-list" id="documentsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <p>No documents yet. Upload files to get started!</p>
                    </div>
                </div>
                
                <!-- Statistics -->
                <h2 style="margin-top: 30px;">üìä Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statFiles">0</div>
                        <div class="stat-label">Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statChunks">0</div>
                        <div class="stat-label">Chunks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSize">0 MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statCollections">3</div>
                        <div class="stat-label">Collections</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test RAG Section -->
        <div class="card" style="margin-top: 30px;">
            <h2>üß™ Test RAG Search</h2>
            <div class="form-group">
                <label for="testQuery">Test Query:</label>
                <input type="text" id="testQuery" placeholder="Ask a question to test RAG...">
            </div>
            <button class="upload-btn" onclick="testRAG()" id="testRAGBtn" style="margin-right: 10px;">Search Knowledge Base</button>
            <button class="upload-btn" onclick="clearTestResults()">Clear Results</button>
            
            <div id="testResults" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentCollection = 'documents';
        let documents = [];
        let collections = [];
        let uploadQueue = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Document Manager initialized');
            checkSystemStatus();
            loadDocuments();
            loadCollections();
            setupDragAndDrop();
            
            // Refresh status every 30 seconds
            setInterval(checkSystemStatus, 30000);
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', filterDocuments);
            
            // Enter key on test query
            document.getElementById('testQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testRAG();
                }
            });
        });
        
        // Check system status - FIXED VERSION
        async function checkSystemStatus() {
            console.log('Checking system status...');
            
            try {
                // Check overall health through orchestrator
                const healthResponse = await fetch('/api/health');
                
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    console.log('Health response:', health);
                    
                    // Update RAG status
                    const ragHealthy = health.services?.rag === true;
                    const ragStatusEl = document.getElementById('ragStatus');
                    if (ragStatusEl) {
                        ragStatusEl.innerHTML = ragHealthy ? 
                            '<span class="status-good">‚úì Online</span>' : 
                            '<span class="status-bad">‚úó Offline</span>';
                    }
                    
                    // Update Milvus status
                    const milvusHealthy = health.services?.milvus === true;
                    const milvusStatusEl = document.getElementById('milvusStatus');
                    if (milvusStatusEl) {
                        milvusStatusEl.innerHTML = milvusHealthy ? 
                            '<span class="status-good">‚úì Connected</span>' : 
                            '<span class="status-bad">‚úó Disconnected</span>';
                    }
                } else {
                    console.error('Health check failed:', healthResponse.status);
                    document.getElementById('ragStatus').innerHTML = '<span class="status-bad">‚úó Error</span>';
                    document.getElementById('milvusStatus').innerHTML = '<span class="status-bad">‚úó Error</span>';
                }
                
                // Load collections info
                await loadCollections();
                
            } catch (error) {
                console.error('Status check error:', error);
                document.getElementById('ragStatus').innerHTML = '<span class="status-bad">‚úó Connection Error</span>';
                document.getElementById('milvusStatus').innerHTML = '<span class="status-bad">‚úó Connection Error</span>';
            }
        }
        
        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }
        
        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                }, false);
            });
            
            // Handle dropped files
            uploadArea.addEventListener('drop', handleDrop, false);
            
            // Handle file selection
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        // Handle file upload - FIXED VERSION
        async function handleFiles(files) {
            const collection = document.getElementById('collectionSelect').value;
            const progressDiv = document.getElementById('uploadProgress');
            const resultsDiv = document.getElementById('uploadResults');
            
            progressDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length * 100).toFixed(0);
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressFill').textContent = progress + '%';
                document.getElementById('uploadStatus').textContent = `Uploading ${file.name}...`;
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch(`/api/documents/upload?collection=${collection}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        successCount++;
                        
                        resultsDiv.innerHTML += `
                            <div class="alert alert-success">
                                ‚úÖ <strong>${file.name}</strong><br>
                                Successfully indexed: ${result.chunks_created || 0} chunks created<br>
                                Collection: ${result.collection || collection}
                            </div>
                        `;
                        
                        console.log('Upload successful:', result);
                    } else {
                        failCount++;
                        let errorMsg = 'Upload failed';
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.detail || errorMsg;
                        } catch {
                            errorMsg = await response.text() || errorMsg;
                        }
                        
                        resultsDiv.innerHTML += `
                            <div class="alert alert-error">
                                ‚ùå <strong>${file.name}</strong><br>
                                Error: ${errorMsg}
                            </div>
                        `;
                        
                        console.error('Upload failed:', errorMsg);
                    }
                } catch (error) {
                    failCount++;
                    resultsDiv.innerHTML += `
                        <div class="alert alert-error">
                            ‚ùå <strong>${file.name}</strong><br>
                            Error: ${error.message}
                        </div>
                    `;
                    console.error('Upload error:', error);
                }
            }
            
            // Final status
            document.getElementById('uploadStatus').textContent = 
                `Complete: ${successCount} succeeded, ${failCount} failed`;
            
            // Reload documents list and update stats
            setTimeout(() => {
                loadDocuments();
                loadCollections();
                checkSystemStatus();
                progressDiv.style.display = 'none';
            }, 2000);
        }
        
        // Submit text content
        async function submitText() {
            const title = document.getElementById('textTitle').value.trim();
            const content = document.getElementById('textContent').value.trim();
            const collection = document.getElementById('textCollection').value;
            
            if (!title || !content) {
                alert('Please provide both title and content');
                return;
            }
            
            try {
                // Create a text file from the content
                const blob = new Blob([content], { type: 'text/plain' });
                const file = new File([blob], title + '.txt', { type: 'text/plain' });
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`/api/documents/upload?collection=${collection}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Success! Created ${result.chunks_created || 0} chunks from your text.`);
                    
                    // Clear form
                    document.getElementById('textTitle').value = '';
                    document.getElementById('textContent').value = '';
                    
                    // Reload documents
                    loadDocuments();
                    loadCollections();
                } else {
                    const error = await response.text();
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Submit URL (placeholder)
        async function submitUrl() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            alert('URL scraping is not yet implemented. Please upload files directly or paste text content.');
        }
        
        // Load documents list - FIXED VERSION
        async function loadDocuments() {
            try {
                // Try to get documents from the backend
                const docsResponse = await fetch('/api/documents?limit=50');
                const docsDiv = document.getElementById('documentsList');
                
                if (docsResponse.ok) {
                    const docsData = await docsResponse.json();
                    console.log('Documents loaded:', docsData);
                    
                    if (docsData.documents && docsData.documents.length > 0) {
                        let html = '';
                        let totalSize = 0;
                        
                        docsData.documents.forEach(doc => {
                            const metadata = doc.metadata || {};
                            const size = metadata.size || 0;
                            totalSize += size;
                            
                            html += `
                                <div class="document-item">
                                    <div class="doc-name">üìÑ ${doc.filename || 'Unknown'}</div>
                                    <div class="doc-info">
                                        <span>Chunks: ${metadata.chunks || 0}</span>
                                        <span>Size: ${formatFileSize(size)}</span>
                                        <span>Collection: ${metadata.collection || 'documents'}</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        docsDiv.innerHTML = html;
                        
                        // Update stats
                        document.getElementById('statFiles').textContent = docsData.documents.length;
                        document.getElementById('statSize').textContent = formatFileSize(totalSize);
                        document.getElementById('totalDocs').innerHTML = 
                            `<span class="status-good">${docsData.documents.length}</span>`;
                        
                    } else {
                        // No documents yet, check collections for vector count
                        docsDiv.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÑ</div>
                                <p>No documents yet. Upload files to get started!</p>
                            </div>
                        `;
                    }
                } else {
                    console.error('Failed to load documents:', docsResponse.status);
                }
                
            } catch (error) {
                console.error('Failed to load documents:', error);
                document.getElementById('documentsList').innerHTML = `
                    <div class="alert alert-error">
                        Failed to load documents: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load collections - FIXED VERSION
        async function loadCollections() {
            try {
                const response = await fetch('/api/collections');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Collections loaded:', data);
                    updateCollectionsDisplay(data);
                    
                    // Update total chunks count
                    let totalChunks = 0;
                    if (data.details) {
                        data.details.forEach(col => {
                            totalChunks += col.num_entities || 0;
                        });
                    }
                    
                    document.getElementById('totalChunks').innerHTML = 
                        `<span class="status-good">${totalChunks}</span>`;
                    document.getElementById('statChunks').textContent = totalChunks;
                    document.getElementById('statCollections').textContent = data.collections?.length || 0;
                    
                } else {
                    console.error('Failed to load collections:', response.status);
                }
            } catch (error) {
                console.error('Failed to load collections:', error);
            }
        }
        
        // Update collections display
        function updateCollectionsDisplay(data) {
            const grid = document.getElementById('collectionsGrid');
            
            if (data.collections && data.collections.length > 0) {
                let html = '';
                
                data.collections.forEach(name => {
                    const detail = data.details?.find(d => d.name === name) || {};
                    const isActive = name === currentCollection;
                    
                    html += `
                        <div class="collection-card ${isActive ? 'active' : ''}" 
                             onclick="selectCollection('${name}')">
                            <div class="collection-name">${name}</div>
                            <div class="collection-count">${detail.num_entities || 0} vectors</div>
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
            } else {
                grid.innerHTML = '<p style="color: #a0a0a0;">No collections found</p>';
            }
        }
        
        // Select collection
        function selectCollection(name) {
            currentCollection = name;
            document.getElementById('activeCollection').innerHTML = 
                `<span class="status-good">${name}</span>`;
            document.getElementById('collectionSelect').value = name;
            document.getElementById('textCollection').value = name;
            loadCollections();
        }
        
        // Filter documents
        function filterDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.document-item');
            
            items.forEach(item => {
                const name = item.querySelector('.doc-name').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Test RAG search - COMPLETELY FIXED VERSION
        async function testRAG() {
            const query = document.getElementById('testQuery').value.trim();
            if (!query) {
                alert('Please enter a test query');
                return;
            }
            
            const resultsDiv = document.getElementById('testResults');
            const testBtn = document.getElementById('testRAGBtn');
            
            // Show loading state
            resultsDiv.innerHTML = '<div class="loading"></div> Searching knowledge base...';
            testBtn.disabled = true;
            
            try {
                // Use the chat endpoint with RAG enabled
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: query,
                        use_rag: true,
                        collection: currentCollection
                    })
                });
                
                console.log('RAG test response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('RAG test response:', data);
                    
                    // Display the response
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h3>üéØ RAG Response:</h3>
                            <p style="margin-top: 15px; white-space: pre-wrap; line-height: 1.6;">${data.response || 'No response generated'}</p>
                            <hr style="margin: 15px 0; opacity: 0.3;">
                            <small>
                                Context used: ${data.context_used ? 'Yes' : 'No'}<br>
                                ${data.context_count ? `Documents found: ${data.context_count}` : ''}
                            </small>
                        </div>
                    `;
                    
                    // If no context was used, show a warning
                    if (!data.context_used) {
                        resultsDiv.innerHTML += `
                            <div class="alert alert-info" style="margin-top: 10px;">
                                <strong>Note:</strong> No relevant documents were found in the knowledge base for this query. 
                                The response is based on the model's general knowledge. 
                                Try uploading relevant documents first.
                            </div>
                        `;
                    }
                } else {
                    // Try to get error details
                    let errorMsg = 'RAG search failed';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.detail || errorMsg;
                    } catch {
                        errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    resultsDiv.innerHTML = `
                        <div class="alert alert-error">
                            <strong>Error:</strong> ${errorMsg}<br>
                            <small>Make sure the services are running and documents are indexed.</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('RAG test error:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>Connection Error:</strong> ${error.message}<br>
                        <small>Check if the backend services are running.</small>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
            }
        }
        
        // Clear test results
        function clearTestResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testQuery').value = '';
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Debug function to test endpoints
        async function debugEndpoints() {
            console.log('=== Testing Endpoints ===');
            
            // Test health endpoint
            try {
                const health = await fetch('/api/health');
                console.log('Health endpoint:', health.status, await health.json());
            } catch (e) {
                console.error('Health endpoint error:', e);
            }
            
            // Test collections endpoint
            try {
                const collections = await fetch('/api/collections');
                console.log('Collections endpoint:', collections.status, await collections.json());
            } catch (e) {
                console.error('Collections endpoint error:', e);
            }
            
            // Test documents endpoint
            try {
                const docs = await fetch('/api/documents');
                console.log('Documents endpoint:', docs.status, await docs.json());
            } catch (e) {
                console.error('Documents endpoint error:', e);
            }
        }
        
        // Add debug command for testing
        window.debugRAG = debugEndpoints;
        console.log('Tip: Run debugRAG() in console to test all endpoints');
    </script>
</body>
</html>
